---
title: "Dashboard ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏®‡∏±‡∏Å‡∏¢‡∏†‡∏≤‡∏û‡∏≠‡∏∏‡∏ï‡∏™‡∏≤‡∏´‡∏Å‡∏£‡∏£‡∏°‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å (BCG Matrix Model)"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
---
 ```{r setup, include=FALSE}
# CHUNK 1: SETUP - ‡πÇ‡∏´‡∏•‡∏î library ‡πÅ‡∏•‡∏∞‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
# ===================================================================

# --- 1.1 ‡πÇ‡∏´‡∏•‡∏î Library ---
library(flexdashboard)
library(readxl)
library(dplyr)
library(tidyr)
library(stringr)
library(ggplot2)
library(plotly)
library(DT)
library(showtext)
library(zoo) # ‡πÄ‡∏û‡∏¥‡πà‡∏° library ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö rollmean (Moving Average)

# --- 1.2 ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ü‡∏≠‡∏ô‡∏ï‡πå ---
font_add_google("Sarabun", "sarabun")
showtext_auto()
showtext_opts(dpi = 300)

# --- 1.3 ‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
file_path <- "Export 60-67.xlsx"
raw_data <- read_excel(file_path, col_names = FALSE)

colnames(raw_data) <- c("product_raw", as.character(raw_data[1, -1]))
cleaned_data <- raw_data[-1, ] %>% filter(!is.na(product_raw))

tidy_data_raw <- cleaned_data %>%
  mutate(group_name = ifelse(str_detect(product_raw, "^[0-9.()]+"), product_raw, NA)) %>%
  fill(group_name, .direction = "down") %>%
  filter(product_raw == group_name) %>%
  select(group_name, matches("^[0-9]{4}$")) %>%
  pivot_longer(cols = -group_name, names_to = "year", values_to = "value") %>%
  mutate(
    year = as.numeric(year),
    value = as.numeric(value),
    category_code = str_extract(group_name, "^[0-9.()]+"),
    category_code = str_replace_all(category_code, "[()]", "")
  ) %>%
  filter(str_count(category_code, "\\.") == 2, !is.na(value)) %>%
  select(category_code, group_name, year, value) %>%
  arrange(category_code, year)

# --- 1.4 [‡πÉ‡∏´‡∏°‡πà] ‡∏ó‡∏≥ Moving Average ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡πÅ‡∏•‡πâ‡∏ß ---

# ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Moving Average ‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
safe_rollmean <- function(x, k) {
  if (length(x) < k) {
    return(rep(NA_real_, length(x)))
  } else {
    return(rollmean(x, k, fill = NA, align = "center"))
  }
}

# ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡πÅ‡∏•‡πâ‡∏ß
tidy_data_smoothed <- tidy_data_raw %>%
  group_by(category_code, group_name) %>%
  mutate(value_smoothed = safe_rollmean(value, k = 3)) %>%
  ungroup()

# ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì CAGR ‡πÅ‡∏•‡∏∞ Volatility ‡∏à‡∏≤‡∏Å "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡πÅ‡∏•‡πâ‡∏ß"
trend_metrics <- tidy_data_smoothed %>%
  filter(!is.na(value_smoothed)) %>%
  group_by(category_code, group_name) %>%
  filter(n() >= 2) %>%
  arrange(year, .by_group = TRUE) %>%
  mutate(yoy_growth_trend = (value_smoothed / lag(value_smoothed)) - 1) %>%
  summarise(
    cagr_trend = {
      first_val <- first(value_smoothed)
      last_val <- last(value_smoothed)
      n_periods <- n() - 1
      if (n_periods > 0 & first_val > 0) {
        ((last_val / first_val)^(1 / n_periods)) - 1
      } else {
        NA_real_
      }
    },
    volatility_trend = sd(yoy_growth_trend, na.rm = TRUE),
    .groups = 'drop'
  )

# ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì "‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢" ‡∏à‡∏≤‡∏Å "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö"
economic_size <- tidy_data_raw %>%
  group_by(category_code, group_name) %>%
  summarise(avg_value = mean(value, na.rm = TRUE), .groups = 'drop')

# ‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
final_model_table <- trend_metrics %>%
  left_join(economic_size, by = c("category_code", "group_name")) %>%
  filter(!is.na(cagr_trend) & !is.na(volatility_trend) & !is.na(avg_value))

 ```
 
 Column {data-width=650}
-----------------------------------------------------------------------

### BCG Matrix: ‡∏®‡∏±‡∏Å‡∏¢‡∏†‡∏≤‡∏û‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏≠‡∏∏‡∏ï‡∏™‡∏≤‡∏´‡∏Å‡∏£‡∏£‡∏°‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏ó‡∏¢

 ```{r bcg_matrix_chart, fig.height=7}
# CHUNK 2: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü BCG Matrix
# ===================================================================
avg_cagr_trend <- median(final_model_table$cagr_trend, na.rm = TRUE)
avg_volatility_trend <- median(final_model_table$volatility_trend, na.rm = TRUE)

plot_data_final <- final_model_table %>%
  mutate(
    quadrant = factor(case_when(
      cagr_trend >= avg_cagr_trend & volatility_trend < avg_volatility_trend  ~ "üåü Stars (‡∏î‡∏≤‡∏ß‡πÄ‡∏î‡πà‡∏ô)",
      cagr_trend >= avg_cagr_trend & volatility_trend >= avg_volatility_trend ~ "‚ùì Question Marks (‡∏î‡∏≤‡∏ß‡∏£‡∏∏‡πà‡∏á)",
      cagr_trend < avg_cagr_trend & volatility_trend < avg_volatility_trend  ~ "üêÆ Cash Cows (‡∏ß‡∏±‡∏ß‡∏ô‡∏°)",
      TRUE ~ "üê∂ Dogs (‡∏™‡∏∏‡∏ô‡∏±‡∏Ç)"
    ), levels = c("üåü Stars (‡∏î‡∏≤‡∏ß‡πÄ‡∏î‡πà‡∏ô)", "‚ùì Question Marks (‡∏î‡∏≤‡∏ß‡∏£‡∏∏‡πà‡∏á)", "üêÆ Cash Cows (‡∏ß‡∏±‡∏ß‡∏ô‡∏°)", "üê∂ Dogs (‡∏™‡∏∏‡∏ô‡∏±‡∏Ç)")),
    hover_text = paste0(
      "<b>", str_trim(str_remove(group_name, "^[0-9.()]+")), "</b>",
      "<br>Trend CAGR: ", scales::percent(cagr_trend, accuracy = 0.1),
      "<br>Trend Volatility: ", scales::percent(volatility_trend, accuracy = 0.1),
      "<br>Avg. Export Value: ", scales::comma(avg_value, accuracy = 1), " M. Baht"
    )
  )

p_final <- ggplot(plot_data_final, aes(x = volatility_trend, y = cagr_trend, color = quadrant, size = avg_value, text = hover_text)) +
  geom_hline(yintercept = avg_cagr_trend, linetype = "dashed", color = "grey60") +
  geom_vline(xintercept = avg_volatility_trend, linetype = "dashed", color = "grey60") +
  geom_point(alpha = 0.7) +
  scale_size_continuous(name = "‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (‡∏•‡πâ‡∏≤‡∏ô‡∏ö‡∏≤‡∏ó)", range = c(2, 18), labels = scales::comma) +
  coord_cartesian(
    xlim = c(0, quantile(plot_data_final$volatility_trend, 0.98, na.rm = TRUE)),
    ylim = c(quantile(plot_data_final$cagr_trend, 0.02, na.rm = TRUE), quantile(plot_data_final$cagr_trend, 0.98, na.rm = TRUE))
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  scale_x_continuous(labels = scales::percent_format(accuracy = 1)) +
  scale_color_manual(name = "‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏®‡∏±‡∏Å‡∏¢‡∏†‡∏≤‡∏û (BCG Matrix):", values = c("üåü Stars (‡∏î‡∏≤‡∏ß‡πÄ‡∏î‡πà‡∏ô)"="#1a9641", "‚ùì Question Marks (‡∏î‡∏≤‡∏ß‡∏£‡∏∏‡πà‡∏á)"="#a6d96a", "üêÆ Cash Cows (‡∏ß‡∏±‡∏ß‡∏ô‡∏°)"="#fdae61", "üê∂ Dogs (‡∏™‡∏∏‡∏ô‡∏±‡∏Ç)"="#d7191c")) +
  labs(
    x = "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏±‡∏ô‡∏ú‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏° (Trend Volatility)", 
    y = "‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡∏Ç‡∏≠‡∏á‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏° (Trend CAGR)",
    caption = "‡πÅ‡∏Å‡∏ô X/Y ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å MA-3 ‡∏õ‡∏µ | ‡∏Ç‡∏ô‡∏≤‡∏î‡∏à‡∏∏‡∏î‡∏Ñ‡∏∑‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ | ‡πÄ‡∏™‡πâ‡∏ô‡πÅ‡∏ö‡πà‡∏á‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡πà‡∏≤‡∏°‡∏±‡∏ò‡∏¢‡∏ê‡∏≤‡∏ô"
  ) +
  guides(color = guide_legend(override.aes = list(size = 5)), size = guide_legend(override.aes = list(color="grey50"))) +
  theme_minimal(base_family = "sarabun", base_size = 12) +
  theme(legend.position = "right", plot.caption = element_text(color="grey50"))

ggplotly(p_final, tooltip = "text") %>%
  layout(legend = list(itemsizing = 'constant'))
 ```

Column {data-width=350}
-----------------------------------------------------------------------

### üåü ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏î‡∏≤‡∏ß‡πÄ‡∏î‡πà‡∏ô

 ```{r stars_table_final}
# CHUNK 3: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á Interactive ‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏î‡∏≤‡∏ß‡πÄ‡∏î‡πà‡∏ô
# ===================================================================
star_performers_final <- final_model_table %>%
  filter(cagr_trend >= median(final_model_table$cagr_trend, na.rm=T) & 
         volatility_trend < median(final_model_table$volatility_trend, na.rm=T)) %>%
  mutate(
    `‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏ï‡∏™‡∏≤‡∏´‡∏Å‡∏£‡∏£‡∏°` = str_trim(str_remove(group_name, "^[0-9.()]+")),
    `Trend CAGR` = scales::percent(cagr_trend, accuracy = 0.1),
    `‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢` = scales::comma(avg_value, accuracy = 1)
  ) %>%
  select(`‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏ï‡∏™‡∏≤‡∏´‡∏Å‡∏£‡∏£‡∏°`, `Trend CAGR`, `‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢`) %>%
  arrange(desc(`Trend CAGR`))

datatable(
  star_performers_final,
  options = list(pageLength = 8, searching = FALSE, lengthChange = FALSE),
  rownames = FALSE,
  class = 'cell-border stripe',
  width = "100%"
)
 ```

### ‚ùì ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏£‡∏∏‡πà‡∏á

 ```{r qm_table_final}
# CHUNK 4: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á Interactive ‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏£‡∏∏‡πà‡∏á
# ===================================================================
qm_performers_final <- final_model_table %>%
  filter(cagr_trend >= median(final_model_table$cagr_trend, na.rm=T) & 
         volatility_trend >= median(final_model_table$volatility_trend, na.rm=T)) %>%
  mutate(
    `‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏ï‡∏™‡∏≤‡∏´‡∏Å‡∏£‡∏£‡∏°` = str_trim(str_remove(group_name, "^[0-9.()]+")),
    `Trend CAGR` = scales::percent(cagr_trend, accuracy = 0.1),
    `‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢` = scales::comma(avg_value, accuracy = 1)
  ) %>%
  select(`‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏ï‡∏™‡∏≤‡∏´‡∏Å‡∏£‡∏£‡∏°`, `Trend CAGR`, `‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢`) %>%
  arrange(desc(`Trend CAGR`))

datatable(
  qm_performers_final,
  options = list(pageLength = 8, searching = FALSE, lengthChange = FALSE),
  rownames = FALSE,
  class = 'cell-border stripe',
  width = "100%"
)
 ```